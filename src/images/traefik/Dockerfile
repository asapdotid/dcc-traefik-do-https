ARG TRAEFIK_VERSION=3.1
FROM mikefarah/yq:4 AS yq
FROM traefik:${TRAEFIK_VERSION} AS base

# Timezone
ARG TIMEZONE
ENV TZ ${TIMEZONE}

# Traefik config
ARG TRAEFIK_LOG_LEVEL
ARG TRAEFIK_DOMAIN_NAME
ENV TRAEFIK_LOG_LEVEL ${TRAEFIK_LOG_LEVEL}
ENV TRAEFIK_DOMAIN_NAME ${TRAEFIK_DOMAIN_NAME}

# Provider
ENV TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER "digitalocean"

# Acme SSL
ARG TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER_EMAIL
ARG TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER_TOKEN
ENV TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER_EMAIL ${TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER_EMAIL}
ENV TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER_TOKEN ${TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER_TOKEN}

# Traefik Dashboard config
ARG TRAEFIK_DASHBOARD
ARG TRAEFIK_DASHBOARD_SUBDOMAIN
ENV TRAEFIK_DASHBOARD ${TRAEFIK_DASHBOARD}
ENV TRAEFIK_DASHBOARD_SUBDOMAIN ${TRAEFIK_DASHBOARD_SUBDOMAIN}

## Traefik Middleware basic auth username config
ARG TRAEFIK_BASIC_AUTH_USERNAME
ARG TRAEFIK_BASIC_AUTH_PASSWORD_HASH
ENV TRAEFIK_BASIC_AUTH_USERNAME ${TRAEFIK_BASIC_AUTH_USERNAME}
ENV TRAEFIK_BASIC_AUTH_PASSWORD_HASH ${TRAEFIK_BASIC_AUTH_PASSWORD_HASH}

## Traefik Middleware rate limit config
ARG TRAEFIK_MID_RATE_LIMIT_AVERAGE
ARG TRAEFIK_MID_RATE_LIMIT_BURST
ENV TRAEFIK_MID_RATE_LIMIT_AVERAGE ${TRAEFIK_MID_RATE_LIMIT_AVERAGE}
ENV TRAEFIK_MID_RATE_LIMIT_BURST ${TRAEFIK_MID_RATE_LIMIT_BURST}

## Middleware SECURITY Headers
ARG TRAEFIK_MID_SEC_CUST_RESPONSE_X_ROBOTS_TAG
ARG TRAEFIK_MID_SEC_CUST_RESPONSE_X_FORWARDED_SERVER
ARG TRAEFIK_MID_SEC_CUST_RESPONSE_X_FORWARDED_PROTO
ARG TRAEFIK_MID_SEC_CUST_REQUEST_X_FORWARDED_PROTO
ARG TRAEFIK_MID_SEC_CUST_SSL_PROXY_X_FORWARDED_PROTO
ARG TRAEFIK_MID_SEC_HOSTS_PROXY
ARG TRAEFIK_MID_SEC_REFERRER_POLICY
ARG TRAEFIK_MID_SEC_CONTENT_TYPE_NO_SNIFF
ARG TRAEFIK_MID_SEC_BROWSER_XSS_FILTER
ARG TRAEFIK_MID_SEC_FORCE_STS_HEADER
ARG TRAEFIK_MID_SEC_STS_INCLUDE_SUBDOMAIN
ARG TRAEFIK_MID_SEC_STS_SECONDS
ARG TRAEFIK_MID_SEC_STS_PRELOAD
ARG TRAEFIK_MID_SEC_FRAME_DENY
ARG TRAEFIK_MID_SEC_CONTENT_SECURITY_POLICY
ARG TRAEFIK_MID_SEC_PERMISSION_POLICY
ENV TRAEFIK_MID_SEC_CUST_RESPONSE_X_ROBOTS_TAG ${TRAEFIK_MID_SEC_CUST_RESPONSE_X_ROBOTS_TAG}
ENV TRAEFIK_MID_SEC_CUST_RESPONSE_X_FORWARDED_SERVER ${TRAEFIK_MID_SEC_CUST_RESPONSE_X_FORWARDED_SERVER}
ENV TRAEFIK_MID_SEC_CUST_RESPONSE_X_FORWARDED_PROTO ${TRAEFIK_MID_SEC_CUST_RESPONSE_X_FORWARDED_PROTO}
ENV TRAEFIK_MID_SEC_CUST_REQUEST_X_FORWARDED_PROTO ${TRAEFIK_MID_SEC_CUST_REQUEST_X_FORWARDED_PROTO}
ENV TRAEFIK_MID_SEC_CUST_SSL_PROXY_X_FORWARDED_PROTO ${TRAEFIK_MID_SEC_CUST_SSL_PROXY_X_FORWARDED_PROTO}
ENV TRAEFIK_MID_SEC_HOSTS_PROXY ${TRAEFIK_MID_SEC_HOSTS_PROXY}
ENV TRAEFIK_MID_SEC_REFERRER_POLICY ${TRAEFIK_MID_SEC_REFERRER_POLICY}
ENV TRAEFIK_MID_SEC_CONTENT_TYPE_NO_SNIFF ${TRAEFIK_MID_SEC_CONTENT_TYPE_NO_SNIFF}
ENV TRAEFIK_MID_SEC_BROWSER_XSS_FILTER ${TRAEFIK_MID_SEC_BROWSER_XSS_FILTER}
ENV TRAEFIK_MID_SEC_FORCE_STS_HEADER ${TRAEFIK_MID_SEC_FORCE_STS_HEADER}
ENV TRAEFIK_MID_SEC_STS_INCLUDE_SUBDOMAIN ${TRAEFIK_MID_SEC_STS_INCLUDE_SUBDOMAIN}
ENV TRAEFIK_MID_SEC_STS_SECONDS ${TRAEFIK_MID_SEC_STS_SECONDS}
ENV TRAEFIK_MID_SEC_STS_PRELOAD ${TRAEFIK_MID_SEC_STS_PRELOAD}
ENV TRAEFIK_MID_SEC_FRAME_DENY ${TRAEFIK_MID_SEC_FRAME_DENY}
ENV TRAEFIK_MID_SEC_CONTENT_SECURITY_POLICY ${TRAEFIK_MID_SEC_CONTENT_SECURITY_POLICY}
ENV TRAEFIK_MID_SEC_PERMISSION_POLICY ${TRAEFIK_MID_SEC_PERMISSION_POLICY}

## Middleware CORS Headers
ARG TRAEFIK_MID_CORS_ALLOW_CREDENTIALS
ARG TRAEFIK_MID_CORS_ALLOW_HEADERS
ARG TRAEFIK_MID_CORS_ALLOW_METHODS
ARG TRAEFIK_MID_CORS_ALLOW_ORIGIN_LIST
ARG TRAEFIK_MID_CORS_MAX_AGE
ARG TRAEFIK_MID_CORS_ADD_VERY_HEADER
ENV TRAEFIK_MID_CORS_ALLOW_CREDENTIALS ${TRAEFIK_MID_CORS_ALLOW_CREDENTIALS}
ENV TRAEFIK_MID_CORS_ALLOW_HEADERS ${TRAEFIK_MID_CORS_ALLOW_HEADERS}
ENV TRAEFIK_MID_CORS_ALLOW_METHODS ${TRAEFIK_MID_CORS_ALLOW_METHODS}
ENV TRAEFIK_MID_CORS_ALLOW_ORIGIN_LIST ${TRAEFIK_MID_CORS_ALLOW_ORIGIN_LIST}
ENV TRAEFIK_MID_CORS_MAX_AGE ${TRAEFIK_MID_CORS_MAX_AGE}
ENV TRAEFIK_MID_CORS_ADD_VERY_HEADER ${TRAEFIK_MID_CORS_ADD_VERY_HEADER}

## Traefik Middleware cache headers
ARG TRAEFIK_MID_RESPONSE_CACHE_CONTROL
ENV TRAEFIK_MID_RESPONSE_CACHE_CONTROL ${TRAEFIK_MID_RESPONSE_CACHE_CONTROL}

## Traefik Middleware compression config
ARG TRAEFIK_MID_COMPRESS
ENV TRAEFIK_MID_COMPRESS ${TRAEFIK_MID_COMPRESS}

# Install required packages
RUN apk add --no-cache --upgrade \
    bash \
    sed \
    tzdata \
    openssl \
    perl-mime-base64

# Clean up unused packages
RUN rm -rf /var/cache/apk/* && \
    rm -rf /tmp/*

# Setup yq command
COPY --from=yq "/usr/bin/yq" "/usr/local/bin/yq"

# Timezone
RUN ln -snf /usr/share/zoneinfo/$TIMEZONE /etc/localtime && echo $TIMEZONE > /etc/timezone

# Copy Traefik configuration
COPY ./images/traefik/config/traefik.yml /etc/traefik/traefik.yml
COPY ./images/traefik/config/dynamic/ /etc/traefik/dynamic/

# Copy entrypoint
COPY ./images/traefik/entrypoint.sh /

# Expose ports
EXPOSE 80 443

# Entrypoint
ENTRYPOINT ["/entrypoint.sh"]

# Default command
CMD [ "traefik" ]

FROM base AS local
